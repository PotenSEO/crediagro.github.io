<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evaluador Financiero - Créditos Agrarios y PYMES</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- jsPDF y XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { background: #f8f9fa; }
    header { text-align: center; margin-bottom: 30px; padding: 24px 12px; border-bottom: 3px solid #0d6efd; background: #fff; }
    header .brand { display:flex; align-items:center; justify-content:center; gap:14px; }
    header .fake-logo { width:68px; height:68px; border-radius:14px; background: linear-gradient(135deg,#0d6efd,#6ea8fe); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800; letter-spacing:1px; font-size:16px; box-shadow:0 6px 18px rgba(13,110,253,.25); }
    #resultados { background: #fff; border-radius: 12px; padding: 22px; margin-top: 30px; border: 1px solid #e5e7eb; box-shadow:0 6px 24px rgba(0,0,0,.05); }
    .desc { font-size: .9rem; color: #495057; font-style: italic; margin-top: .25rem; }
    .soportes { font-size: .85rem; color: #6c757d; margin: .25rem 0 .75rem; }
    .membrete h5 { margin:0; color:#0d6efd; }
    .firma { margin-top: 48px; }
    .firma .linea { border-top: 1px solid #111; width: 280px; margin-top: 48px; }
    .small-muted { color:#6c757d; font-size:.9rem; }
    .section-title { font-weight: 700; color: #0d6efd; margin-top: 18px; }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="fake-logo">LOGO</div>
    <div>
      <h2 class="text-primary m-0">Evaluador Financiero - Créditos Agrarios y PYMES</h2>
      <div class="small-muted">Informe y análisis automático de indicadores financieros</div>
    </div>
  </div>
</header>

<div class="container mb-5">
  <form id="formularioFinanciero" class="row g-3" onsubmit="event.preventDefault(); evaluarCliente();">

    <!-- Empresa -->
    <div class="col-md-8">
      <label class="form-label">Nombre de la empresa / persona natural o jurídica</label>
      <input type="text" id="nombreEmpresa" class="form-control" required placeholder="Ej: Agroindustria del Norte S.A.S">
      <div class="desc">Razón social o nombre completo del solicitante.</div>
      <div class="soportes">Soportes: Certificado de existencia y representación legal / Registro mercantil / Documento de identidad.</div>
    </div>

    <!-- Tipo de empresa -->
    <div class="col-md-4">
      <label class="form-label">Tipo de empresa</label>
      <select id="tipoEmpresa" class="form-select" required>
        <option value="">Seleccione...</option>
        <option>Persona Natural</option>
        <option>S.A.S</option>
        <option>S.A</option>
        <option>Ltda (S. de R.L.)</option>
        <option>Empresa Unipersonal (E.U.)</option>
        <option>Sociedad Colectiva</option>
        <option>Sociedad en Comandita Simple (S. en C.)</option>
        <option>Sociedad en Comandita por Acciones (S.C.A.)</option>
        <option>Cooperativa</option>
        <option>Fundación</option>
      </select>
      <div class="desc">Seleccione la naturaleza jurídica conforme a la legislación colombiana.</div>
      <div class="soportes">Soportes: Certificado cámara de comercio / Estatutos / RUT.</div>
    </div>

    <!-- Ingresos -->
    <div class="col-md-6">
      <label class="form-label">Ingresos Totales Anuales (declaración de renta)</label>
      <input type="text" id="ingresos" class="form-control" required oninput="formatPesos(this)" placeholder="Ej: 1.000.000">
      <div class="desc">Total de ingresos brutos generados en el año fiscal. Refleja la capacidad de generación de recursos.</div>
      <ul class="soportes mb-0">
        <li>Declaración de renta del último año.</li>
        <li>Certificados de ingresos y retenciones.</li>
        <li>Estados financieros auditados (NIIF).</li>
      </ul>
    </div>

    <!-- Costos -->
    <div class="col-md-6">
      <label class="form-label">Costos y Gastos Operativos Anuales</label>
      <input type="text" id="costos" class="form-control" required oninput="formatPesos(this)" placeholder="Ej: 500.000">
      <div class="desc">Gastos relacionados con la operación del negocio: insumos, nómina, servicios, etc.</div>
      <ul class="soportes mb-0">
        <li>Facturas y comprobantes de gastos.</li>
        <li>Registros contables ajustados según NIIF.</li>
      </ul>
    </div>

    <!-- Utilidad Neta -->
    <div class="col-md-6">
      <label class="form-label">Utilidad Neta Anual</label>
      <input type="text" id="utilidadNeta" class="form-control" required oninput="formatPesos(this)" placeholder="Ej: 200.000">
      <div class="desc">Ganancia final luego de descontar costos, gastos e impuestos.</div>
      <ul class="soportes mb-0">
        <li>Estado de resultados (PyG) / Declaración de renta.</li>
      </ul>
    </div>

    <!-- EBIT -->
    <div class="col-md-6">
      <label class="form-label">EBIT (Utilidad antes de Intereses e Impuestos)</label>
      <input type="text" id="ebit" class="form-control" required oninput="formatPesos(this)" placeholder="Ej: 250.000">
      <div class="desc">Mide la rentabilidad operativa sin efectos financieros ni tributarios.</div>
      <ul class="soportes mb-0">
        <li>Estados financieros auditados (NIIF).</li>
        <li>Reportes contables detallados.</li>
      </ul>
    </div>

    <!-- Gastos Intereses -->
    <div class="col-md-6">
      <label class="form-label">Gastos por Intereses Anuales</label>
      <input type="text" id="gastosIntereses" class="form-control" required oninput="formatPesos(this)" placeholder="Ej: 50.000">
      <div class="desc">Pagos por intereses de deudas durante el año.</div>
      <ul class="soportes mb-0">
        <li>Estados financieros.</li>
        <li>Contratos de crédito y extractos bancarios.</li>
      </ul>
    </div>

    <!-- Deuda Total -->
    <div class="col-md-6">
      <label class="form-label">Deuda Total</label>
      <input type="text" id="deuda" class="form-control" required oninput="formatPesos(this)" placeholder="Ej: 1.200.000">
      <div class="desc">Obligaciones financieras de corto y largo plazo al cierre del periodo.</div>
      <ul class="soportes mb-0">
        <li>Balance general / Estado de situación financiera.</li>
        <li>Contratos y extractos de préstamo.</li>
      </ul>
    </div>

    <!-- Activo Total -->
    <div class="col-md-6">
      <label class="form-label">Activo Total</label>
      <input type="text" id="activo" class="form-control" required oninput="formatPesos(this)" placeholder="Ej: 3.000.000">
      <div class="desc">Valor total de bienes y derechos de la empresa.</div>
      <ul class="soportes mb-0">
        <li>Balance general auditado.</li>
        <li>Inventarios y registros de propiedad.</li>
      </ul>
    </div>

    <!-- Activo Corriente -->
    <div class="col-md-6">
      <label class="form-label">Activo Corriente</label>
      <input type="text" id="activoCorriente" class="form-control" required oninput="formatPesos(this)" placeholder="Ej: 1.500.000">
      <div class="desc">Activos líquidos o convertibles en efectivo en menos de un año.</div>
      <ul class="soportes mb-0">
        <li>Balance general.</li>
        <li>Extractos bancarios y cuentas por cobrar.</li>
      </ul>
    </div>

    <!-- Pasivo Corriente -->
    <div class="col-md-6">
      <label class="form-label">Pasivo Corriente</label>
      <input type="text" id="pasivoCorriente" class="form-control" required oninput="formatPesos(this)" placeholder="Ej: 1.000.000">
      <div class="desc">Obligaciones exigibles en menos de un año.</div>
      <ul class="soportes mb-0">
        <li>Balance general.</li>
        <li>Contratos y extractos de deuda.</li>
      </ul>
    </div>

    <!-- Impuesto ley 6ta -->
    <div class="col-md-6">
      <label class="form-label">Impuesto adicional Ley 6ta (%) sobre utilidad neta</label>
      <input type="number" id="impuesto6ta" class="form-control" step="0.01" min="0" max="100" required placeholder="Ej: 9">
      <div class="desc">Porcentaje adicional aplicable a la utilidad neta según normativa vigente.</div>
      <ul class="soportes mb-0">
        <li>Declaración de renta.</li>
        <li>Normativa tributaria aplicable.</li>
      </ul>
    </div>

    <!-- Cuota crédito -->
    <div class="col-md-6">
      <label class="form-label">Cuota mensual del crédito solicitado</label>
      <input type="text" id="cuotaCredito" class="form-control" required oninput="formatPesos(this)" placeholder="Ej: 200.000">
      <div class="desc">Valor mensual estimado a pagar por el crédito solicitado.</div>
      <ul class="soportes mb-0">
        <li>Simulador de crédito del banco.</li>
        <li>Propuesta o contrato crediticio.</li>
      </ul>
    </div>

    <!-- Botones -->
    <div class="col-12 mt-3 d-flex flex-wrap gap-2">
      <button type="submit" class="btn btn-success">Evaluar Cliente</button>
      <button type="reset" class="btn btn-secondary" id="btnLimpiar">Limpiar</button>
      <button type="button" class="btn btn-danger" onclick="exportarPDF()">Exportar PDF</button>
      <button type="button" class="btn btn-primary" onclick="exportarExcel()">Exportar Excel</button>
      <button type="button" class="btn btn-warning" onclick="exportarWord()">Exportar Word</button>
    </div>
  </form>

  <div id="resultados" class="mt-4 membrete">
    <div class="d-flex align-items-center gap-3 mb-3">
      <div class="fake-logo" style="width:52px;height:52px;font-size:12px;">LOGO</div>
      <div>
        <h5>Informe Empresarial - Evaluación de Crédito</h5>
        <div id="stampFecha" class="small-muted"></div>
      </div>
    </div>
    <div id="bloqueResultados" class="pt-2">
      <em class="text-muted">Complete el formulario y presione "Evaluar Cliente" para ver resultados...</em>
    </div>

    <div class="firma">
      <div class="linea"></div>
      <div class="mt-2">Firma Responsable</div>
      <div class="text-muted">Cargo / Empresa</div>
    </div>
  </div>
</div>

<script>
// ==================== UTILIDADES ====================
const fmtPesos = (n) => new Intl.NumberFormat('es-CO', { maximumFractionDigits: 0 }).format(n);
function formatPesos(input){ let v=input.value.replace(/[^\d]/g,''); input.value = v ? v.replace(/\B(?=(\d{3})+(?!\d))/g,'.') : ''; }
function parsePesos(v){ return v? parseFloat(v.replace(/\./g,'')) : 0; }

let ultimaEvaluacion = null;

function selloFecha(){
  const ahora = new Date();
  // Mostrar fecha/hora local del navegador (Colombia del usuario)
  document.getElementById('stampFecha').textContent = `Fecha y hora del reporte: ${ahora.toLocaleString()}`;
}

selloFecha();
setInterval(selloFecha, 60_000);

document.getElementById('btnLimpiar').addEventListener('click',()=>{
  document.getElementById('bloqueResultados').innerHTML = '<em class="text-muted">Formulario reiniciado. Ingrese datos y presione "Evaluar Cliente".</em>';
  ultimaEvaluacion = null;
});

// ==================== EVALUACIÓN ====================
function evaluarCliente(){
  const nombre = document.getElementById('nombreEmpresa').value.trim();
  const tipo = document.getElementById('tipoEmpresa').value;
  const ingresos = parsePesos(document.getElementById('ingresos').value);
  const costos = parsePesos(document.getElementById('costos').value);
  const utilidadNeta = parsePesos(document.getElementById('utilidadNeta').value);
  const ebit = parsePesos(document.getElementById('ebit').value);
  const gastosIntereses = parsePesos(document.getElementById('gastosIntereses').value);
  const deuda = parsePesos(document.getElementById('deuda').value);
  const activo = parsePesos(document.getElementById('activo').value);
  const activoCorriente = parsePesos(document.getElementById('activoCorriente').value);
  const pasivoCorriente = parsePesos(document.getElementById('pasivoCorriente').value);
  const impuesto6ta = parseFloat(document.getElementById('impuesto6ta').value);
  const cuotaCredito = parsePesos(document.getElementById('cuotaCredito').value);

  const campos = [ingresos, costos, utilidadNeta, ebit, gastosIntereses, deuda, activo, activoCorriente, pasivoCorriente, cuotaCredito];
  if(campos.some(c=>isNaN(c)||c<0) || isNaN(impuesto6ta) || impuesto6ta<0 || impuesto6ta>100){
    alert('Por favor ingrese valores válidos (números no negativos) y un impuesto entre 0 y 100.');
    return;
  }

  const razonEndeudamiento = activo>0 ? deuda/activo : 0;
  const razonLiquidez = pasivoCorriente>0 ? activoCorriente/pasivoCorriente : 0;
  const margenNeto = ingresos>0 ? utilidadNeta/ingresos : 0;
  const coberturaIntereses = (gastosIntereses===0) ? 'Sin gastos por intereses' : (gastosIntereses>0 ? ebit/gastosIntereses : 0);
  const impuestoAdicional = utilidadNeta * (impuesto6ta/100);
  const ingresosMensuales = ingresos/12;
  const porcentajeCuota = ingresosMensuales>0 ? (cuotaCredito/ingresosMensuales)*100 : 0;

  let aprobacion = true; let razones = [];
  if(razonEndeudamiento >= 0.6){ aprobacion = false; razones.push('Razón de endeudamiento alta (>= 0.6).'); }
  if(razonLiquidez < 1.2){ aprobacion = false; razones.push('Razón de liquidez baja (< 1.2).'); }
  if(margenNeto < 0.05){ aprobacion = false; razones.push('Margen neto insuficiente (< 5%).'); }
  if(gastosIntereses > 0 && coberturaIntereses < 1.5){ aprobacion = false; razones.push('Cobertura de intereses baja (< 1.5).'); }
  if(porcentajeCuota > 30){ aprobacion = false; razones.push('Cuota mensual supera el 30% de ingresos.'); }

  ultimaEvaluacion = {
    nombre, tipo, ingresos, costos, utilidadNeta, ebit, gastosIntereses, deuda,
    activo, activoCorriente, pasivoCorriente, impuesto6ta, cuotaCredito,
    razonEndeudamiento, razonLiquidez, margenNeto, coberturaIntereses, impuestoAdicional, ingresosMensuales, porcentajeCuota, aprobacion, razones
  };

  const filas = [
    ['Razón de Endeudamiento', (razonEndeudamiento*100).toFixed(2) + '%'],
    ['Razón de Liquidez', razonLiquidez.toFixed(2)],
    ['Margen Neto', (margenNeto*100).toFixed(2) + '%'],
    ['Cobertura de Intereses', (typeof coberturaIntereses==='string') ? coberturaIntereses : coberturaIntereses.toFixed(2)],
    ['Impuesto adicional Ley 6ta', '$ ' + fmtPesos(Math.round(impuestoAdicional))],
    ['Cuota/Ingresos mensuales', porcentajeCuota.toFixed(2) + '%']
  ];

  const decision = aprobacion ? '<span class="text-success fw-bold">Cliente POTENCIAL para crédito.</span>'
                              : '<span class="text-danger fw-bold">Cliente NO cumple con el perfil requerido.</span>';

  const razonesHTML = !aprobacion ? `<h6 class="mt-2">Razones:</h6><ul>${razones.map(r=>`<li>${r}</li>`).join('')}</ul>` : '';

  document.getElementById('bloqueResultados').innerHTML = `
    <div class="row g-3">
      <div class="col-12 col-md-6">
        <div class="section-title">Solicitante</div>
        <div><strong>Empresa:</strong> ${nombre} (${tipo})</div>
      </div>
      <div class="col-12 col-md-6">
        <div class="section-title">Resumen</div>
        <div>${decision}</div>
      </div>
      <div class="col-12">
        <div class="section-title">Indicadores calculados</div>
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-2">
            <thead class="table-light"><tr><th>Indicador</th><th>Valor</th></tr></thead>
            <tbody>
              ${filas.map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join('')}
            </tbody>
          </table>
        </div>
        ${razonesHTML}
      </div>
    </div>
  `;
}

// ==================== EXPORTACIONES ====================
function buildReportText(){
  if(!ultimaEvaluacion){ return 'Sin evaluación generada.'; }
  const u = ultimaEvaluacion;
  const head = `Evaluador Financiero - Informe Empresarial\nEmpresa: ${u.nombre} (${u.tipo})\nFecha: ${new Date().toLocaleString()}\n`;
  const lines = [
    `Razón de Endeudamiento: ${(u.razonEndeudamiento*100).toFixed(2)}%`,
    `Razón de Liquidez: ${u.razonLiquidez.toFixed(2)}`,
    `Margen Neto: ${(u.margenNeto*100).toFixed(2)}%`,
    `Cobertura de Intereses: ${typeof u.coberturaIntereses==='string'?u.coberturaIntereses:u.coberturaIntereses.toFixed(2)}`,
    `Impuesto adicional Ley 6ta: $ ${fmtPesos(Math.round(u.impuestoAdicional))}`,
    `Cuota/Ingresos mensuales: ${u.porcentajeCuota.toFixed(2)}%`,
    `Decisión: ${u.aprobacion? 'Cliente POTENCIAL para crédito.' : 'Cliente NO cumple con el perfil requerido.'}`
  ];
  if(!u.aprobacion && u.razones?.length){ lines.push('Razones:'); u.razones.forEach(r=>lines.push(' - '+r)); }
  return head + '\n' + lines.join('\n');
}

function buildReportHTML(){
  if(!ultimaEvaluacion){ return '<p>Sin evaluación generada.</p>'; }
  const u = ultimaEvaluacion;
  const fecha = new Date().toLocaleString();
  const tabla = `
    <table border="1" cellpadding="6" cellspacing="0" width="100%" style="border-collapse:collapse; font-family:Arial, sans-serif; font-size:12pt;">
      <tr style="background:#f1f3f5"><th align="left">Indicador</th><th align="left">Valor</th></tr>
      <tr><td>Razón de Endeudamiento</td><td>${(u.razonEndeudamiento*100).toFixed(2)}%</td></tr>
      <tr><td>Razón de Liquidez</td><td>${u.razonLiquidez.toFixed(2)}</td></tr>
      <tr><td>Margen Neto</td><td>${(u.margenNeto*100).toFixed(2)}%</td></tr>
      <tr><td>Cobertura de Intereses</td><td>${typeof u.coberturaIntereses==='string'?u.coberturaIntereses:u.coberturaIntereses.toFixed(2)}</td></tr>
      <tr><td>Impuesto adicional Ley 6ta</td><td>$ ${fmtPesos(Math.round(u.impuestoAdicional))}</td></tr>
      <tr><td>Cuota/Ingresos mensuales</td><td>${u.porcentajeCuota.toFixed(2)}%</td></tr>
    </table>`;

  const decision = u.aprobacion ? '<strong style="color:green;">Cliente POTENCIAL para crédito.</strong>'
                                : '<strong style="color:#d6336c;">Cliente NO cumple con el perfil requerido.</strong>';

  const razones = (!u.aprobacion && u.razones?.length)
    ? `<h4>Razones</h4><ul>${u.razones.map(r=>`<li>${r}</li>`).join('')}</ul>`
    : '';

  return `
  <div style="text-align:center; font-family:Arial, sans-serif;">
    <img src="https://via.placeholder.com/150x80.png?text=LOGO" alt="Logo" style="max-height:80px"><br>
    <h2 style="color:#0d6efd; margin:6px 0 0;">Evaluador Financiero - Informe Empresarial</h2>
    <div style="color:#6c757d;">Fecha y hora: ${fecha}</div>
    <hr style="border:0;border-top:2px solid #0d6efd; margin:16px 0;">
  </div>
  <p><strong>Empresa:</strong> ${u.nombre} (${u.tipo})</p>
  ${tabla}
  <p><strong>Decisión:</strong> ${decision}</p>
  ${razones}
  <div style="margin-top:48px;">
    <div style="border-top:1px solid #000; width:280px; margin-top:36px;"></div>
    <div>Firma Responsable</div>
    <div style="color:#6c757d;">Cargo / Empresa</div>
  </div>`;
}

function exportarPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });
  const W = doc.internal.pageSize.getWidth();
  const margin = 48; // 48pt ~ 17mm
  const fecha = new Date().toLocaleString();

  // Membrete: "logo" vectorial y títulos
  // Rectángulo color como logo ficticio
  doc.setFillColor(13,110,253); // #0d6efd
  doc.roundedRect(margin, margin-6, 56, 56, 8, 8, 'F');
  doc.setTextColor(255,255,255);
  doc.setFontSize(10); doc.text('LOGO', margin+14, margin+24);

  doc.setTextColor(13,110,253); doc.setFontSize(16);
  doc.text('Evaluador Financiero - Informe Empresarial', margin+72, margin+12);
  doc.setTextColor(108,117,125); doc.setFontSize(10);
  doc.text('Fecha y hora: '+fecha, margin+72, margin+28);

  // línea separadora
  doc.setDrawColor(13,110,253); doc.setLineWidth(2);
  doc.line(margin, margin+52, W-margin, margin+52);

  // Cuerpo
  const cuerpo = buildReportText();
  doc.setTextColor(0,0,0); doc.setFontSize(12);
  const textWidth = W - margin*2;
  const lines = doc.splitTextToSize(cuerpo, textWidth);

  let y = margin+72; const lineHeight = 16;
  lines.forEach(line=>{
    if(y > doc.internal.pageSize.getHeight() - margin - 90){
      doc.addPage(); y = margin; // nueva página
    }
    doc.text(line, margin, y); y += lineHeight;
  });

  // Firma al pie de página de la última página
  const H = doc.internal.pageSize.getHeight();
  doc.setDrawColor(0); doc.line(margin, H - 80, margin + 280, H - 80);
  doc.setTextColor(0); doc.setFontSize(12);
  doc.text('Firma Responsable', margin, H - 60);
  doc.setTextColor(108,117,125); doc.text('Cargo / Empresa', margin, H - 44);

  doc.save('Reporte_Financiero.pdf');
}

function exportarExcel(){
  if(!ultimaEvaluacion){ alert('Primero genere una evaluación.'); return; }
  const u = ultimaEvaluacion;
  const data = [
    ['Empresa', `${u.nombre} (${u.tipo})`],
    ['Fecha', new Date().toLocaleString()],
    ['Razón de Endeudamiento', (u.razonEndeudamiento*100).toFixed(2)+'%'],
    ['Razón de Liquidez', u.razonLiquidez.toFixed(2)],
    ['Margen Neto', (u.margenNeto*100).toFixed(2)+'%'],
    ['Cobertura de Intereses', (typeof u.coberturaIntereses==='string'?u.coberturaIntereses:u.coberturaIntereses.toFixed(2))],
    ['Impuesto adicional Ley 6ta', fmtPesos(Math.round(u.impuestoAdicional))],
    ['Cuota/Ingresos mensuales', u.porcentajeCuota.toFixed(2)+'%'],
    ['Decisión', u.aprobacion? 'Cliente POTENCIAL' : 'NO cumple perfil']
  ];
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Reporte');
  XLSX.writeFile(wb, 'Reporte_Financiero.xlsx');
}

function exportarWord(){
  const html = buildReportHTML();
  const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'Reporte_Financiero.doc'; a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
